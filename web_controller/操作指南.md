# 故障注入控制器操作指南（Hadoop + VM + KVM）

> 本指南针对 Ubuntu 24 ARM 上运行的控制器（宿主机），集群节点为 3 台（192.168.1.10/11/12）。

## 1. 前置准备

### 1.1 启动虚拟机集群
在宿主机上使用 `vm_injection/run_cluster.sh` 启动 master/slave：
```bash
cd /path/to/fault-injection/vm_injection
./run_cluster.sh master
./run_cluster.sh slave1
./run_cluster.sh slave2
```

### 1.2 Hadoop 集群启动
确保 Hadoop 已安装在 master（`/opt/hadoop`），且 master 可免密 SSH 访问 slave：
```bash
source /etc/profile

hdfs --daemon start namenode
hdfs --daemon start secondarynamenode

ssh slave1 "source /etc/profile; hdfs --daemon start datanode"
ssh slave2 "source /etc/profile; hdfs --daemon start datanode"

yarn --daemon start resourcemanager

ssh slave1 "source /etc/profile; yarn --daemon start nodemanager"
ssh slave2 "source /etc/profile; yarn --daemon start nodemanager"
```

### 1.3 编译注入工具
在宿主机与 master 上分别编译相关工具（建议一次性编译）：
```bash
cd /home/venele/grad_project/kvm_injection/hadoop-fi
make

cd /home/venele/grad_project/vm_injection
make all
```

确认以下二进制存在（宿主机路径）：\n+- `/home/venele/grad_project/kvm_injection/hadoop-fi/hadoop_injector` （仅 Hadoop 注入时在 master 上执行）\n+- `/home/venele/grad_project/vm_injection/process_injector`\n+- `/home/venele/grad_project/vm_injection/network_injector`\n+- `/home/venele/grad_project/vm_injection/cpu_injector`\n+- `/home/venele/grad_project/vm_injection/mem_leak`\n+- `/home/venele/grad_project/vm_injection/mem_injector`\n+- `/home/venele/grad_project/vm_injection/reg_injector`\n+- `/home/venele/grad_project/vm_injection/kvm_injector`

如路径不同，请在配置中修改。

---

## 2. 配置控制器

编辑 `web_controller/config.json`：\n+- `hadoop.injector`: `/home/venele/grad_project/kvm_injection/hadoop-fi/hadoop_injector`\n+- `vm.*`: `/home/venele/grad_project/vm_injection/...`\n+- `kvm.injector`: `/home/venele/grad_project/vm_injection/kvm_injector`\n+- `nodes`: 192.168.1.10/11/12
- `use_sudo`: 若需要 root 操作且已配置免密 sudo，则设为 `true`

---

## 3. 启动控制器
```bash
cd /path/to/fault-injection
python3 -m venv .venv
. .venv/bin/activate
pip install -r web_controller/requirements.txt
uvicorn web_controller.app:app --host 0.0.0.0 --port 8080
```
访问：`http://<宿主机IP>:8080`

如需在启动前端时自动拉起 3 台虚拟机，可使用脚本：
```bash
cd /path/to/fault-injection
./start_frontend.sh
```

现在直接用 `uvicorn` 启动时也会自动拉起 3 台虚拟机（依赖 `vm_injection/run_cluster.sh` 可执行）。

---

## 4. 使用说明（按模块）

### 4.1 集群管理
- **节点进程状态 (jps)**：查看各节点 Hadoop 进程
- **启动/停止/重启 Hadoop**：在 master 执行 start/stop 脚本

### 4.2 Hadoop 进程故障
- 选择操作：`crash / hang / resume`
- 选择组件：`nn/dn/rm/nm/snn/jhs`

### 4.3 网络故障
- **延迟/丢包/乱序/隔离/心跳超时**
- 目标可以输入 `slave1` 或 IP
- 隔离/乱序等操作为高风险，执行后请记得用清理按钮恢复

### 4.4 资源故障
- **CPU 压力**：对指定节点施压
- **内存压力**：占用内存
- **磁盘填满**：制造大文件
- **I/O 限速**：通过 cgroup 限速

### 4.5 HDFS / YARN
- **安全模式**：enter/leave
- **HDFS 磁盘不足**
- **YARN 不健康**：模拟 NodeManager unhealthy

### 4.6 MapReduce
- **Map/Reduce 任务故障**：杀死任务进程

### 4.7 VM 注入
- **进程控制**：`crash/hang/resume` (进程名，如 `qemu-system-aarch64`)
- **网络故障**：
  - delay: `100ms`
  - loss: `10%`
  - partition: `8080`
  - corrupt: `1%`
  - clear: 无参数
- **CPU 压力**：PID 可选（0 表示全局）
- **内存泄漏**：设置 MB 大小
- **内存注入**：ptrace 注入，必须 root
- **寄存器注入**：ARM64 寄存器注入，支持延迟/循环

### 4.8 KVM 注入
- **KVM 虚拟机列表**：先获取虚拟机 PID
- **软错误注入**：寄存器位翻转/交换/置零
- **客户OS错误行为**：数据段异常/除零/非法指令
- **性能故障**：延迟 / CPU 压力 / 清理
- **CPU 热插拔**：上线/下线指定 CPU
- **KVM 一键清理**：恢复所有 KVM 故障

---

## 5. 常见问题

1. **提示权限不足**\n+- ptrace/iptables/tc/cgroup 操作需要 root\n+- 建议使用 root 运行控制器，或配置免密 sudo 并开启 `use_sudo`

2. **Hadoop 注入无法执行**\n+- Hadoop 注入是在 master/slave 上执行，请确认宿主机到 master 的 SSH 可达\n+- master 到 slave 的免密 SSH 已配置

2. **找不到工具**
- 检查 `config.json` 中路径是否正确
- 确认二进制已编译

3. **无输出或输出截断**
- 控制器会限制输出行数与字符数
- 可在 `config.json` 中调整 `output.max_lines/max_chars`

---

如需新增按钮或定制操作流程，请告诉我具体的注入步骤，我可以继续扩展。
